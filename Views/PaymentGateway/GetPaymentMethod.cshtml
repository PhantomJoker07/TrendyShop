@model TrendyShop.ViewModels.PaymentMethodViewModel

@{
    ViewData["Title"] = "GetPaymentMethod";
}

<div class="col-lg-5 mx-auto mt-4">
    <div class="card">
        <div class="card-body">
            <h1 class="card-title border-bottom">Complete su orden: </h1>
            @*@using (Html.BeginForm("EffectBuy", "Buy", new { aid = @Model.Add.ArticleId, uid = @Model.Add.UserId, card = @Model.Card, amountToBuy = @Model.AmountToBuy }))*@
            @using (Html.BeginForm("FinishPayment", "PaymentGateway", FormMethod.Post, new { id = "pform" }))
            {
                <h3>Añada una tarjeta para realizar el pago:</h3>

                <div class=" form-group">
                    @Html.LabelFor(m => m.NameOnCard)
                    @Html.TextBoxFor(m => m.NameOnCard, new { @class = "form-control", @id = "cardName" })
                    @Html.ValidationMessageFor(m => m.NameOnCard)
                </div>

                <div class=" form-group">
                    @Html.LabelFor(m => m.CardNumber)
                    @Html.TextBoxFor(m => m.CardNumber, new { @class = "form-control", @id = "cardNumber" })
                    @Html.ValidationMessageFor(m => m.CardNumber)
                </div>

                <h3>O elija una de las registradas:</h3>

                //podemos actually tener un card que sea una clase con NameOnCard y CardNumber
                <div class=" form-group">
                    @Html.LabelFor(m => m.CardNumber)
                    @Html.DropDownListFor(m => m.CardNumber, new SelectList(Model.Cards, "CardNumber", "CardNumber"), "", new { @class = "form-control" })
                </div>

                @Html.HiddenFor(m => m.UserId)
                @*@Html.HiddenFor(m => m.SellerId)*@
                @Html.HiddenFor(m => m.ArticleId)
                @Html.HiddenFor(m => m.DateTicks)
                @Html.HiddenFor(m => m.Charge)
            }


            <div class="d-flex">
                <button class="btn btn-secondary ml-auto" onclick="insertData()">Realizar pago</button>

                <form asp-action="CancelOrder" asp-controller="Buy" asp-route-userId=@Model.UserId asp-route-articleId=@Model.ArticleId asp-route-dateTicks=@Model.DateTicks>
                    <button class="btn btn-dark ml-1" type="submit">Cancelar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div>
    @if (Model.InvalidOperation)
    {
        @section scripts {
            <script type="text/javascript">
                $('#warningModal').modal()
            </script>
        }
    }
</div>

@*<div class="d-flex">
        <button onclick="insertData()">Realizar pago</button>

        <form asp-action="CancelOrder" asp-controller="Buy" asp-route-userId=@Model.UserId asp-route-articleId=@Model.ArticleId asp-route-dateTicks=@Model.DateTicks>
            <button class="ml-1" type="submit">Cancelar</button>
        </form>
    </div>*@

<div class="modal fade" id="warningModal" tabindex="-1" role="dialog" aria-labelledby="warningModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="WarningModalLongTitle">No se pudo avalar la transacción</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h3>Lo sentimos, al parecer la tarjeta seleccionada no cuenta con fondos suficientes</h3>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary ml-auto" data-dismiss="modal">Elegir otra</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmodal" tabindex="-1" role="dialog" aria-labelledby="ConfirmationModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ConfirmationModalLongTitle">Confirmación de pago</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h1>Se descontará @Model.Charge de su cuenta. ¿Desea continuar?</h1>

                @*<div class="d-flex">
                        <input onclick="finishOperation()" class="ml-1  btn-dark" value="Continuar" />
                    </div>*@
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary ml-auto" onclick="finishOperation()">Continuar</button>
                <button class="btn btn-dark ml-1" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function insertData() {
        var valResult = validateForm();

        if (valResult) {
            $('#confirmodal').modal()
        }
    }

    function validateForm() {
        nameOnCard = document.getElementById("cardName").value;
        cardNumber = document.getElementById("cardNumber").value;
        var dropDownList = document.getElementById("CardNumber");
        cardNumberDDL = dropDownList.options[dropDownList.selectedIndex].text;

        //cards most have from 13 - 18 digits
        if (cardNumberDDL == "" && (nameOnCard == "" || (cardNumber.length < 13 || cardNumber.length > 18))) {
            alert("Por favor especifique un número de tarjeta válido para efectuar su compra");
            return false;
        }
        return true;
    }

    function finishOperation() {
        submitForm();
    }

    function submitForm() {
        document.getElementById('pform').submit();
    }
</script>